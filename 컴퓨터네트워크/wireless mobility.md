# Wireless & Mobility

[TOC]

와이어리스라는 말은 기기에 선 없이 네트워크 연결이 되는 것. 와이파이. 

모빌리티라는 말은 액세스 포인트가 바뀌는 것. 3G, LTE는 계속해서 기지국이 바뀔 수 있기 때문에 모빌리티, 하지만 와이파이는 그럴 수 없으니 모빌리티가 아니다.

## Wireless

802.11이 와이파이다. 

### Wireless network

|                | Single hop                | Multiple hops |
| -------------- | ------------------------- | ------------- |
| Infrastructure | 우리가 쓰는 건 거의 이거. |               |
| no infra       |                           |               |

 유선 링크의 경우, 케이블이 있고, 껍질로 둘러싸여 있다. 그래서 받을 때까지 데이터의 신호가 거의 줄지 않는다. 하지만 무선 네트워크는 외부의 영향을 많이 받는다. 공기라는 미디엄을 통해 가는 것이기 때문에 전송거리에 반비례하게 신호세기가 정해진다. 

 A에서 B에게 무언가 보내고 있는데, C도 B에게 보내고 있다. 유선이라면 CSMA/CD로 판단하면 되는데, A가 말하는 것은 C 입장에선 거의 안들리기 때문에 그냥 말한다. 그러면 충돌나는 것. 유선 상에서 썼던 CSMA/CD를 쓰기엔 무리가 있다. 이러한 문제를 Hidden terminal problem이라고 한다.

### IEEE 802.11 Wireless LAN

 802.11b부터 시작해서 802.11a, 802.11n 등 점점 빨라지고 있음. Wi(ireless)-Fi(ddility). 원래는 HiFi의 패러디이다. HiFi는 오디오 세계에서 실제 원음에 충실한 레코딩 방법이었다. 유선 속도만큼 가깝게 하겠다는 목표를 가지고 와이파이라고 부름.

#### Architecture

 AP(Access Point)에 연결 되어있고, 와이파이 호스트의 집합을 BSS라고 한다. 

#### Scanning

 유선 연결이 안되어 있으면 무선 연결을 확인해야 함. DHCP로 IP를 받기 위해서는 기본적으로 링크가 연결되어 있어야 함. 랩탑이 가장 처음에 하는 일은 내가 어떤 AP와 연결을 맺을지. 인터페이스 카드가 와이파이 채널을 스캐닝한다. 어떤 ap가 있는지. AP들이 주기적으로 자신을 브로드캐스팅한다. 그 중에 우리가 선택하면 해당하는 AP한테 연결하는 것. 그 이후에 DHCP와 통신하는 것이다.

#### Hidden Termianl Problem : Collision Avoidance

 무선에서는 거리가 Critical Factor이다. 멀리있으면 소리가 안들림. Collision Detection이 안된다. 그래서 Collision Avoidancd를 사용한다. 

 캐리어 센스했는데 아무도 이야기하지 않는다. 아무도 이야기하지 않는 것처럼 느껴지면 전체 프레임 다 보낸다. 이전에는 충돌감지하면 끊었는데, 여기선 그런 개념이 없다. 걍 다 보냄. 대신 ACK를 받는다. 링크 레이어임에도 불구하고 피드백이 있다. 이더넷의 경우는 갔는지 아닌지 확신할 수 있었다. 충돌만 아니면 무조건 도착한 것인데, 무선의 경우는 충돌이 아니더라도 데이터가 제대로 갔는지 확신할 수 없다. 유선에 비해 시간이 더 걸린다. 1) 한 번 보내면 멈추지 않고 다 보내기 때문에(어차피 디텍션 잘 못하니까) 2) ACK까지 받아야 하기 때문에. ACK를 받지 못했으면 재전송 해야 함. 그 말은 나 말고 다른 사람이 보내고 있다는 말이니까, 랜덤 벡터로 경쟁하다가 다시 보냄. 또 안오면 또 기다렸다가 또 보냄. 계속 그렇게 한다. 그렇게 하다가 연속 7번까지 ack를 받지 못하면 포기한다. 그러면 영원히 유실되는 건 아니다. 링크 레이어에선 끝난거지만 나중에 TCP에서 타이머 시간지나면 재전송 할 것.

 충돌이 날 수 있다는 사실과 충돌 감지가 안된다는 사실은 어쩔 수 없다. 이 데미지를 줄이기 위한 노력이 있다. 

#### RTS-CTS exchange

 RTS(Ready to send)라는 작은 컨트롤 프레임을 보낸다. 그러면 이 답장으로 AP는 CTS를 보낸다. 그것은 너 보내도 돼 라는 말. A와 B 둘 다 RTS를 보내서 충돌이 난 경우, A와 B는 모두 cts를 받지 못한다. 충돌난 것을 알고 random backup을 실시한다. 둘 중의 한 명이 먼저 rts를 보낸다면 (A라고 가정),  cts(A)가 브로드캐스트 될 것이다. 그러면 A가 데이터를 보낸다. 

 A가 전송한 것에 대해 B가 듣지 못하기 때문에 문제가 발생했다. 그러나 rts, cts가 있기 때문에, 이 채널을 사용하는 것은 a라는 의미로 cts(a)를 주변의 모든 인터페이스가 듣게 된다. A를 제외한 AP 반경의 모든 기기에 대해 데이터 보낼 수 있는 호스트는 A밖에 없다고 알려주는 것. 

 갑자기 C가 와서 프레임 보내고자 한다. 캐리어 센스를 해보니 아무도 안보낸다. rts를 보내면 데이터와 충돌할 것이다. 그러면 다시 랜덤 백업 시작. 모두가 경쟁상태로 돌입할 것이다. 

#### 802.11 Frame : addressing

 ![wifi frame header에 대한 이미지 검색결과](https://witestlab.poly.edu/blog/content/images/2017/03/wifi-frame-1.svg)

- frame body : 패킷이 들어가는 공간.
- Duration 시간만큼 내 cts가 유지된다.
- address 1 : AP MAC addr 
- address 2 : Host Mac addr
- address 3 : Router Mac addr
- address 4 : 

address field가 3개 연속으로 있고, 또 하나 더 있다. 왜 그럴까.

AP는 특이한 장비이다. 한쪽 면은 무선이고, 한쪽 면은 무선이다. 양쪽 세상에 걸쳐있다. 무선 세상에서 봤을 때 AP는 링크 레이어에 존재하는 장비이다.  유선에서 봤을 때 AP는 스위치와 동일하다. AP는 링크 레이어 디바이스이다. 안을 까서 보면 링크 레이어까지만 구현되어 있다.

 이러한 상황에서 Host에서 보낸 프레임이 라우터로 가기 위해서 어떻게 해야 할까. 호스트는 네트워크 레이어 입장에서 next hop은 라우터이다. 무선에서 유선으로 나갈 수 있는 유일한 통로가 AP이기 때문에 호스트는 AP로 데이터를 쏜다. 그 때 AP가 하는 역할은 링크 레이어 역할. 와이파이 프레임으로 받아서 유선 프레임으로 바꿔준다. 라우터 입장에서 AP는 안보이기 때문에(스위치라서) Host에 바로 보낸다. 그러면 AP가 중간에서 받아서 wifi frame으로 바꿔준다. 

#### 802.11 : mobility within same subnet

 ![wifi same subnet에 대한 이미지 검색결과](https://i.stack.imgur.com/NZGjI.png)

  같은 서브넷이기 때문에 IP는 바뀌지 않음. 그런데 저쪽 AP로 가던 데이터를 이쪽 AP로 다시 옮겨야 한다. 현재 유지되는 session이 유지되느냐 끊어지느냐가 중요하다. 나는 걸어가면서도 youtube를 보고 싶다. 이것이 모빌리티가 세션에 영향을 주지 않는 것이다. 

 세션은 TCP 세션이다.(udp가 될 수도 있고) TCP Session이 유지되냐 아니냐를 밝혀야 한다. 어떻게 알 수 있을까. 내 IP, 서버 IP, 내 포트, 서버 포트가 그대로 있어야 한다. 이 4가지가 동일하게 유지되어야 세션이 유지된다. 서버IP와 서버포트는 변하지 않을 것이다. 그러나 내가 이동하면 다른 서브넷으로 이동할 수도 있다. 이 때 IP 변화가 일어날 수 있는 것이다.  유튜브 보는데 같은 라우터 내의 다른 서브넷으로 가는 경우는 IP 변화가 없으므로 세션이 유지된다.

### Cellular

![cellular network에 대한 이미지 검색결과](https://upload.wikimedia.org/wikipedia/commons/5/57/CellTowersAtCorners.gif)

 이동통신사는 와이파이가 아니다. 이동통신사의 핵심은 모빌리티가 세션에 영향을 미치지 않도록 하는 것이다. 셀룰러 네트워크에 대해 깊이 이야기하지 않음. TCP/IP와는 다르다. 개념 잡는 정도로만.

 셀룰러라는 것은 셀, 세포처럼 생겼다. 땅을 세포 모양으로  해놓고,  세포 하나하나마다 베이스 스테이션이라고 불리는 AP를 세워놓고 무선 링크를 만들었다는 의미이다. 이것도 첫 홉만 무선이고 나머지는 유선이다. 다른점은 이것이 802.11으로 이용되는 것은 아니라는 것. 통신사만의 특수한 프로토콜이 존재한다. 무선과 연결된 유선도 CSMA/CD가 아니라 완전히 다른 것을 쓴다.

 예전에는 FDMA / TDMA 등을 썼다. 시간으로 나눠서 쓰든, 주파수를 나눠서 쓰든. 모드를 나눠서 쓰든(CDMA). 핵심은 서로 안겹치게 해놓은 것이다.

 데이터 속도가 어느 정도 이상이되는 어떤 기술이든지 4G라고 해줄게, 5G라고 해줄게.라고 한다. 특정 기술이 5G가 아니라 10Gbps만 충족하면 5G가 되는 것이다. 4G 시장을 LTE이다. 그래서 LTE라고 보내는 것이다. 처음에 4G를 선점하기 위해 LTE와 WiMAX라는 군단이 붙었다. 하나의 회사가 아니라 여러 회사의 집단이다. 세력이 나눠진 것. 4G 시장을 놓고 WiMAX는 삼성전자, LTE는 오렌지 텔레콤 등이 주축이 되어서 붙었지만 LTE가 이겼다. 합리적인 이유는 기존의 3G 기지국에서 미니멀한 업그레이드로 전환이 가능했다. 세상은 승자가 다 먹기 때문에 WiMAX는 사장되었다.

 ![lte cellular network에 대한 이미지 검색결과](https://image.slidesharecdn.com/intermediate001architecture2gto5g-170917155341/95/highlevel-architecture-of-mobile-cellular-networks-from-2g-to-5g-5-638.jpg?cb=1505664082)

 Public Internet이 있으면 GGSN이라는 게이트웨이가 있다. 그 아래에 SGSN이라는 애들이 있고, 그 아래에 RNC라는 애들이 있고, 그 아래에 BSC라는 애들이 있고 그 아래에 BS라는 애들이 있다. 피라미드 구조이다. 

 LTE로 연결되었다는 말은, 내가 인터넷에 들어갔을 때 기지국과 연결되었다는 것. 기지국 여러개를 관리하는 RNC, 여러개의 RNC를 관리하는 SGSN, 다양한 SGSN을 관리하는 GGSN 이렇게 이동한다. 내 기기에서 IP 패킷을 만들어서 생산한 후 BS에 보낼 때는 와이파이 프레임에 보내는 것이 아니라 BS의 고유한 프레임을 만들어 보내는 것이다. 

 LTE로 연결된 IP주소는 누가 준걸까. GGSN이 관리를 한다. 이 IP주소는 GGSN 내부에서만 고유한 IP 주소이다. 결국에는 GGSN의 IP주소로 나가게 된다. 이걸로 인터넷할 때 내 아이피 주소가 뭐지 검색할 때는 통신사의 IP주소가 나오게 된다. 

 역삼에서 청량리까지 LTE로 유튜브 끊기지 않고 갈 수 있을까. 세션 유지될까 안될까. 내 IP가 안바뀌면 바뀔 일 없다. GGSN이라는 서브넷 안에 있으니까 아이피가 바뀔 일이 없다. 엄청난 규모의 인프라가 이미 있기 때문에. 